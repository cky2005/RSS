<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Reader</title>
    <link rel="icon" href="static/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <header class="header">
        <div class="header-main">
            <div class="site-title">
                <i class="mdi mdi-rss-box"></i>
                <span>RSS</span>
            </div>
            <nav class="nav-items">
                <div class="category-item active" data-category="Blog">
                    <i class="mdi mdi-post"></i>
                    <span>博客</span>
                </div>
                <div class="category-item" data-category="Information">
                    <i class="mdi mdi-newspaper"></i>
                    <span>资讯</span>
                </div>
                <div class="category-item" data-category="Forums">
                    <i class="mdi mdi-forum"></i>
                    <span>论坛</span>
                </div>
            </nav>
            <div class="update-time">
                <i class="mdi mdi-clock-outline"></i>
                <span id="update-time"></span>
            </div>
        </div>
    </header>

    <nav class="mobile-nav">
        <div class="category-item active" data-category="Blog">
            <i class="mdi mdi-post"></i>
            <span>博客</span>
        </div>
        <div class="category-item" data-category="Information">
            <i class="mdi mdi-newspaper"></i>
            <span>资讯</span>
        </div>
        <div class="category-item" data-category="Forums">
            <i class="mdi mdi-forum"></i>
            <span>论坛</span>
        </div>
    </nav>
    <main class="articles" id="articles"></main>
    <script>
        const GITHUB_REPO = 'imjiaoyuan/RSS';

        function escapeString(str) {
            return str
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/\t/g, '\\t');
        }

        function createGitHubIssue(title, summary, date, link, type = 'comment') {
            const issueTitle = `${title} (${date})`;
            const cleanSummary = summary.split(/[。！？.!?]/)[0].replace(/\s+/g, ' ').trim();
            const issueBody = `${cleanSummary}。\n\n链接：${link}`;
            const label = type === 'comment' ? 'comment' : 'favorite';
            const issueUrl = `https://github.com/${GITHUB_REPO}/issues/new?title=${encodeURIComponent(issueTitle)}&body=${encodeURIComponent(issueBody)}&labels=${label}`;
            
            window.open(issueUrl, '_blank');
        }

        function isToday(dateStr) {
            const today = new Date();
            const articleDate = new Date(dateStr);
            return today.toDateString() === articleDate.toDateString();
        }

        function renderArticle(article) {
            const isRead = localStorage.getItem(`read_${article.link}`) === 'true';
            const safeTitle = escapeString(article.title);
            const safeSummary = escapeString(article.summary || '无摘要');
            
            return `
                <article class="article ${isRead ? 'read' : ''}" data-link="${article.link}">
                    <a href="${article.link}" class="article-title" target="_blank" 
                       onclick="markAsRead(event, '${article.link}')">${article.title}</a>
                    <div class="article-summary">
                        ${article.summary || '无摘要'}
                    </div>
                    <div class="article-meta">
                        <a href="${article.source_url}" class="meta-item source-link" target="_blank">
                            <i class="mdi mdi-rss"></i>
                            <span>${article.author}</span>
                        </a>
                        <div class="meta-item">
                            <i class="mdi mdi-calendar-clock"></i>
                            <span>${article.date}</span>
                        </div>
                        <div class="button-group">
                            <div class="meta-item favorite-button" onclick="createGitHubIssue('${safeTitle}', '${safeSummary}', '${article.date}', '${article.link}', 'favorite')">
                                <i class="mdi mdi-bookmark-outline"></i>
                                <span>收藏</span>
                            </div>
                            <div class="meta-item comment-button" onclick="createGitHubIssue('${safeTitle}', '${safeSummary}', '${article.date}', '${article.link}', 'comment')">
                                <i class="mdi mdi-message-outline"></i>
                                <span>评论</span>
                            </div>
                        </div>
                    </div>
                </article>`;
        }

        function markAsRead(event, link) {
            // 存储已读状态
            localStorage.setItem(`read_${link}`, 'true');
            
            // 找到对应的文章元素并添加已读样式
            const article = event.target.closest('.article');
            if (article) {
                article.classList.add('read');
            }
        }

        // 在页面加载时恢复已读状态
        function restoreReadStatus() {
            document.querySelectorAll('.article').forEach(article => {
                const link = article.dataset.link;
                if (localStorage.getItem(`read_${link}`) === 'true') {
                    article.classList.add('read');
                }
            });
        }

        let currentCategory = 'Blog';
        
        function filterArticles(articles, category) {
            return articles.filter(article => article.category === category);
        }
        
        function updateActiveCategory(category) {
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.category === category) {
                    item.classList.add('active');
                }
            });
        }
        
        async function loadArticles(category = 'Blog') {
            try {
                const response = await fetch('feed.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                document.getElementById('update-time').textContent = `${data.update_time.split(' ')[0]}`;
                const articlesContainer = document.getElementById('articles');
                
                if (!data.articles || !Array.isArray(data.articles)) {
                    throw new Error('Invalid data format');
                }

                const filteredArticles = filterArticles(data.articles, category);
                
                if (filteredArticles.length === 0) {
                    articlesContainer.innerHTML = `
                        <div class="empty-message">
                            <i class="mdi mdi-information"></i>
                            <span>该分类下暂无文章</span>
                        </div>`;
                    return;
                }

                let html = '';

                if (category === 'Forums') {
                    html = `
                        <div class="article-section">
                            ${filteredArticles.map(renderArticle).join('')}
                        </div>`;
                } else {
                    const todayArticles = filteredArticles.filter(article => isToday(article.date));
                    const olderArticles = filteredArticles.filter(article => !isToday(article.date));

                    if (todayArticles.length > 0) {
                        html += `
                            <div class="section-title">
                                <i class="mdi mdi-star"></i>
                                <span>今日更新</span>
                                <small>(${todayArticles.length}篇)</small>
                            </div>
                            <div class="article-section">
                                ${todayArticles.map(renderArticle).join('')}
                            </div>`;
                    }

                    if (olderArticles.length > 0) {
                        html += `
                            <div class="section-title ${todayArticles.length > 0 ? 'history-title' : ''}">
                                <i class="mdi mdi-history"></i>
                                <span>历史文章</span>
                                <small>(${olderArticles.length}篇)</small>
                            </div>
                            <div class="article-section">
                                ${olderArticles.map(renderArticle).join('')}
                            </div>`;
                    }
                }

                articlesContainer.innerHTML = html;
                
                // 恢复已读状态
                restoreReadStatus();
            } catch (error) {
                document.getElementById('articles').innerHTML = `
                    <div class="error-message">
                        加载文章失败：${error.message}<br>
                        请检查 feed.json 文件是否存在并且格式正确
                    </div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadArticles('Blog');
            updateActiveCategory('Blog');
            
            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', () => {
                    const category = item.dataset.category;
                    currentCategory = category;
                    updateActiveCategory(category);
                    loadArticles(category);
                });
            });
        });
    </script>
    <style>
        .error-message {
            color: #dc3545;
            padding: 20px;
            text-align: center;
            background: var(--header-bg);
            border-radius: 8px;
            margin-top: 20px;
        }
    </style>
</body>
</html>